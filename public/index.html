<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Member Medications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#38bdf8; --danger:#ef4444; --input:#0b1220; --border:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a 30%);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial}
    header{padding:24px 20px;border-bottom:1px solid var(--border);background:rgba(17,24,39,.6);backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    main{max-width:1060px;margin:28px auto;padding:0 16px 64px}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:1fr 1fr}
    .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--border);border-radius:14px;padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select, button, textarea{font:inherit;color:var(--text);background:var(--input);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:none}
    input::placeholder{color:#64748b}
    button{cursor:pointer;border:1px solid #334155}
    button.primary{background:linear-gradient(135deg,var(--accent),#16a34a);color:#04120a}
    button.secondary{background:linear-gradient(135deg,var(--accent-2),#0ea5e9);color:#03121a}
    button.ghost{background:transparent;color:var(--muted)}
    button.danger{background:linear-gradient(135deg,#ef4444,#b91c1c);color:#1b0a0a}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .search-wrap{position:relative}
    .dropdown{position:absolute;left:0;right:0;top:100%;background:#0b1020;border:1px solid var(--border);border-radius:12px;margin-top:6px;max-height:300px;overflow:auto;z-index:20;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .dropdown .opt{padding:10px 12px;border-bottom:1px solid #0f172a;cursor:pointer}
    .dropdown .opt:hover{background:#0d1426}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:14px}
    th{color:#9ca3af;font-weight:600;background:#0c1224;position:sticky;top:70px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #334155;color:#a5b4fc}
    .stack{display:flex;flex-direction:column;gap:10px}
    .hint{font-size:12px;color:#93c5fd}
    .warn{font-size:12px;color:#fca5a5}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;border:1px solid #1f2a44;padding:12px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.5);display:none}
    .toast.show{display:block}
    .spacer{height:6px}
    @media (max-width:900px){ .cols-2{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <h1>Member Medications</h1>
  <div class="hint">Dual‚Äëmode: secure proxy (default) or direct-to-Quotit (unsafe; testing only). üî®ü§ñüîß</div>
</header>

<main>
  <div class="grid cols-2">
    <!-- LEFT: Member & Environment -->
    <section class="card stack">
      <h2 style="margin:0 0 6px 0;font-size:16px">Member & Environment</h2>

      <div class="row">
        <div>
          <label>Mode</label>
          <select id="mode">
            <option value="proxy">Proxy (secure, recommended)</option>
            <option value="direct">Direct to Quotit (unsafe)</option>
          </select>
        </div>
        <div>
          <label>Environment</label>
          <select id="env">
            <option value="stg">Staging</option>
            <option value="prod">Production</option>
          </select>
        </div>
      </div>

      <div id="keysWrap" class="row" style="display:none">
        <div>
          <label>RemoteAccessKey (GUID)</label>
          <input id="rak" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
        </div>
        <div>
          <label>WebsiteAccessKey (GUID)</label>
          <input id="wak" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
        </div>
      </div>
      <div class="row" id="rememberWrap" style="display:none;align-items:center">
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="rememberKeys" />
          <span class="muted">Remember keys for this tab (sessionStorage)</span>
        </label>
        <button id="clearKeys" class="ghost" style="flex:0 0 auto">Clear saved</button>
      </div>
      <div id="warnDirect" class="warn" style="display:none">
        ‚ùó Direct mode exposes keys in the browser and can be blocked by CORS. Use only for quick testing.
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>FamilyId</label>
          <input id="familyId" placeholder="e.g. 12345" />
        </div>
        <div>
          <label>ContactId (alternative to FamilyId)</label>
          <input id="contactId" placeholder="e.g. 67890" />
        </div>
        <div>
          <label>MemberId (optional)</label>
          <input id="memberId" placeholder="e.g. 9c1e... (string)" />
        </div>
      </div>

      <div class="row">
        <button class="secondary" id="btnLoad">Load current drugs</button>
        <button class="ghost" id="btnLoadHistory">Load incl. history</button>
        <button class="ghost" id="btnProbe">Fetch Family (probe)</button>
      </div>
      <div id="probeOut" class="muted" style="margin-top:6px"></div>

      <div class="spacer"></div>
      <div class="hint">Enter <strong>FamilyId</strong> or <strong>ContactId</strong>. Member filters are optional.</div>
    </section>

    <!-- RIGHT: Search/Add -->
    <section class="card stack">
      <h2 style="margin:0 0 6px 0;font-size:16px">Find a drug</h2>
      <div class="search-wrap">
        <label>Search by name, NDC or RxCUI</label>
        <input id="drugSearch" placeholder="e.g. Atorvastatin 10 mg" autocomplete="off" />
        <div id="drugDropdown" class="dropdown" style="display:none"></div>
      </div>
      <div class="row">
        <div>
          <label>Selected NDC</label>
          <input id="ndc" placeholder="11-digit NDC" />
        </div>
        <div>
          <label>Drug Name</label>
          <input id="drugName" placeholder="Generic or brand" />
        </div>
        <div>
          <label>Is Brand?</label>
          <select id="isBrand">
            <option value="false">No (generic)</option>
            <option value="true">Yes (brand)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Quantity</label>
          <input id="qty" type="number" min="0" step="1" placeholder="e.g. 30" />
        </div>
        <div>
          <label>Frequency</label>
          <select id="freq">
            <option value="">--</option>
            <option value="1">Monthly</option>
            <option value="2">Daily</option>
            <option value="3">Weekly</option>
            <option value="4">Quarterly</option>
            <option value="5">Annually</option>
            <option value="6">SemiAnnually</option>
            <option value="7">Per30Days</option>
            <option value="8">Per60Days</option>
            <option value="9">Per90Days</option>
          </select>
        </div>
        <div>
          <label>From Date</label>
          <input id="fromDate" type="date" />
        </div>
        <div>
          <label>To Date (optional)</label>
          <input id="toDate" type="date" />
        </div>
      </div>

      <div class="row">
        <button class="primary" id="btnAdd">Add Drug</button>
        <button id="btnClear" class="ghost">Clear fields</button>
      </div>
      <div class="hint">NDC, Drug Name, and From Date are required. If you set Quantity, set Frequency too.</div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2 style="margin:0 0 10px 0;font-size:16px">Current Drugs</h2>
    <div class="muted" id="memberLabel"></div>
    <div class="spacer"></div>
    <table id="tbl">
      <thead>
        <tr>
          <th>NDC</th><th>Name</th><th>Brand?</th><th>Qty/Freq</th><th>From ‚Üí To</th><th>Created</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
/** ========================
 *  CONFIG
 *  ======================== */
const CONFIG = {
  proxy: {
    stg: '/api/actws/stg',
    prod: '/api/actws/prod'
  },
  directBases: {
    stg: 'https://wwwstg.quotit.net/Quotit/Apps/Common/ActWS/ACA/v2',
    prod: 'https://www.quotit.net/Quotit/Apps/Common/ActWS/ACA/v2'
  },
  storageKeys: {
    rak: 'actws_rak',
    wak: 'actws_wak',
    remember: 'actws_remember'
  }
};

// UI helpers
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const toast = (msg, type='info') => {
  const t = $('#toast'); t.textContent = msg; t.classList.add('show');
  t.style.borderColor = type==='error' ? '#7f1d1d' : '#1f2a44';
  setTimeout(()=>t.classList.remove('show'), 3400);
};

// State
let currentMember = { familyId:null, contactId:null, memberId:null, memberGUID:null, includeHistory:false };
let cachedRows = [];
let selectedDrug = null;

// ===== Remember Keys (sessionStorage) =====
function loadSavedKeys(){
  const remember = sessionStorage.getItem(CONFIG.storageKeys.remember) === '1';
  $('#rememberKeys').checked = remember;
  if (remember){
    $('#rak').value = sessionStorage.getItem(CONFIG.storageKeys.rak) || '';
    $('#wak').value = sessionStorage.getItem(CONFIG.storageKeys.wak) || '';
  }
}
function saveKeysIfOpted(){
  const remember = $('#rememberKeys').checked;
  sessionStorage.setItem(CONFIG.storageKeys.remember, remember ? '1' : '0');
  if (remember){
    sessionStorage.setItem(CONFIG.storageKeys.rak, $('#rak').value.trim());
    sessionStorage.setItem(CONFIG.storageKeys.wak, $('#wak').value.trim());
  } else {
    sessionStorage.removeItem(CONFIG.storageKeys.rak);
    sessionStorage.removeItem(CONFIG.storageKeys.wak);
  }
}
$('#rememberKeys').addEventListener('change', saveKeysIfOpted);
$('#rak').addEventListener('input', saveKeysIfOpted);
$('#wak').addEventListener('input', saveKeysIfOpted);
$('#clearKeys').addEventListener('click', ()=>{
  sessionStorage.removeItem(CONFIG.storageKeys.rak);
  sessionStorage.removeItem(CONFIG.storageKeys.wak);
  sessionStorage.removeItem(CONFIG.storageKeys.remember);
  $('#rak').value = ''; $('#wak').value = ''; $('#rememberKeys').checked = false;
  toast('Cleared keys from sessionStorage');
});

// Mode toggling
$('#mode').addEventListener('change', onModeChange);
function onModeChange(){
  const direct = $('#mode').value === 'direct';
  $('#keysWrap').style.display = direct ? 'flex' : 'none';
  $('#rememberWrap').style.display = direct ? 'flex' : 'none';
  $('#warnDirect').style.display = direct ? 'block' : 'none';
  if (direct){ loadSavedKeys(); }
}
onModeChange(); // initialize on first paint

// Helpers
function apiTarget(method){
  const mode = $('#mode').value;
  const env  = $('#env').value;
  if (mode === 'proxy'){
    return { url: CONFIG.proxy[env], direct:false };
  } else {
    return { url: `${CONFIG.directBases[env]}/${method}`, direct:true };
  }
}

// ====== POST ======
async function postActWS(method, bodySansKeys){
  const { url, direct } = apiTarget(method);
  let body = bodySansKeys;

  if (direct){
    // inject keys from inputs
    const rak = $('#rak').value.trim();
    const wak = $('#wak').value.trim();
    if(!rak || !wak) throw new Error('RemoteAccessKey and WebsiteAccessKey are required in Direct mode');
    body = { ...bodySansKeys, RemoteAccessKey: rak, WebsiteAccessKey: wak };
  }

  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(direct ? body : { method, body })
  });

  if(!res.ok) throw new Error('HTTP '+res.status+' '+await res.text());
  return res.json();
}

// ====== SEARCH DRUGS (SearchRxDrugs) ======
let searchTimer = null;
$('#drugSearch').addEventListener('input', (e)=>{
  const q = e.target.value.trim();
  if (searchTimer) clearTimeout(searchTimer);
  if (q.length < 3) { $('#drugDropdown').style.display='none'; return; }
  searchTimer = setTimeout(()=> searchDrugs(q).catch(err=>toast(err.message,'error')), 250);
});

async function searchDrugs(keyword){
  const data = await postActWS('SearchRxDrugs', {
    AccessKeys: {}, // proxy injects; direct requires RAK/WAK (added above)
    Inputs: { Keyword: keyword }
  });
  const list = (data.Drugs || []).slice(0, 30);
  const dd = $('#drugDropdown'); dd.innerHTML='';
  list.forEach(drug=>{
    (drug.DrugPackages||[]).forEach(pkg=>{
      const div = document.createElement('div');
      div.className='opt';
      div.innerHTML = `
        <div><strong>${drug.BrandName || drug.GenericName || 'Unknown'}</strong> <span class="pill">${pkg.NDC}</span></div>
        <div class="muted" style="font-size:12px">${pkg.FDAProductName||''} ¬∑ ${pkg.PackageDescription||''}</div>`;
      div.onclick = ()=>{
        selectedDrug = { ndc: pkg.NDC, name: (drug.GenericName || drug.BrandName || '').trim() || (pkg.FDAProductName||'').trim(), isBrand: !!pkg.IsBrand };
        $('#ndc').value = selectedDrug.ndc;
        $('#drugName').value = selectedDrug.name;
        $('#isBrand').value = selectedDrug.isBrand ? 'true' : 'false';
        dd.style.display='none';
      };
      dd.appendChild(div);
    });
  });
  dd.style.display = dd.childElementCount ? 'block' : 'none';
}

// ====== LOAD MEMBER DRUGS ======
$('#btnLoad').addEventListener('click', ()=> loadMember(false));
$('#btnLoadHistory').addEventListener('click', ()=> loadMember(true));

async function loadMember(includeHistory){
  currentMember = {
    familyId: $('#familyId').value.trim() || null,
    contactId: $('#contactId').value.trim() || null,
    memberId: $('#memberId').value.trim() || null,
    memberGUID: null,
    includeHistory
  };
  if(!currentMember.familyId && !currentMember.contactId){
    toast('Provide FamilyId or ContactId', 'error'); return;
  }

  const resp = await postActWS('GetMemberDrugs', {
    RemoteAccessKey: null, WebsiteAccessKey: null,
    FamilyId: currentMember.familyId ? Number(currentMember.familyId) : undefined,
    ContactId: currentMember.contactId ? Number(currentMember.contactId) : undefined,
    MemberId: currentMember.memberId || undefined,
    MemberGUID: currentMember.memberGUID || undefined,
    IncludeHistoricalData: !!includeHistory
  });

  const rows = (resp.MembersDrugs||[]).flatMap(m => (m.Drugs||[]).map(d => ({ memberId:m.MemberId||m.MemberGUID, ...d })));
  cachedRows = rows;
  const msg = rows.length
    ? `${rows.length} drug(s) found` + (currentMember.memberId||currentMember.memberGUID ? ` for member ${currentMember.memberId||currentMember.memberGUID}` : ' (all members)') + (includeHistory?' ¬∑ incl. history':'')
    : 'No drugs found for the supplied IDs.';
  $('#memberLabel').textContent = msg;
  renderTable();
}

function renderTable(){
  const tb = $('#tbody'); tb.innerHTML='';
  if (!cachedRows.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="7" class="muted">No drug records to display.</td>`;
    tb.appendChild(tr);
    return;
  }
  cachedRows.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    const range = (r.ToDate ? `${r.FromDate} ‚Üí ${r.ToDate}` : `${r.FromDate} ‚Üí ‚Ä¶`);
    tr.innerHTML = `
      <td>${r.NDC}</td>
      <td>${r.DrugName}</td>
      <td>${r.IsBrand ? 'Brand' : 'Generic'}</td>
      <td>${(r.Quantity??'‚Äì')}/${freqLabel(r.Frequency)}</td>
      <td>${range}</td>
      <td><span class="muted" title="CreatedTime">${r.CreatedTime || '‚Äî'}</span></td>
      <td class="row" style="gap:6px">
        <button class="ghost" onclick="prefill(${idx})">Edit</button>
        <button class="danger" onclick="deleteDrug(${idx})">Delete</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}
window.prefill = (i)=>{
  const r = cachedRows[i];
  $('#ndc').value = r.NDC; $('#drugName').value = r.DrugName; $('#isBrand').value = r.IsBrand?'true':'false';
  $('#qty').value = r.Quantity ?? ''; $('#freq').value = r.Frequency ?? '';
  $('#fromDate').value = r.FromDate ? r.FromDate.substring(0,10) : ''; $('#toDate').value = r.ToDate ? r.ToDate.substring(0,10) : '';
  selectedDrug = { ndc:r.NDC, name:r.DrugName, isBrand:!!r.IsBrand, createdTime:r.CreatedTime };
  toast('Loaded drug into editor. Edit then click ‚ÄúAdd Drug‚Äù to save changes as Edit.');
};

window.deleteDrug = async (i)=>{
  const r = cachedRows[i];
  if(!confirm(`Delete ${r.DrugName} (${r.NDC})?`)) return;
  try{
    await submitMemberDrugs('Delete', [{ ...r }]);
    toast('Deleted ‚úÖ');
    await loadMember(currentMember.includeHistory);
  }catch(e){ toast(e.message,'error');}
};

function freqLabel(n){
  const map = {1:'Monthly',2:'Daily',3:'Weekly',4:'Quarterly',5:'Annually',6:'SemiAnnually',7:'Per30Days',8:'Per60Days',9:'Per90Days'};
  return map[n] || '‚Äì';
}

// ====== ADD / EDIT ======
$('#btnAdd').addEventListener('click', async ()=>{
  try{
    const drug = {
      NDC: $('#ndc').value.trim(),
      DrugName: $('#drugName').value.trim(),
      IsBrand: $('#isBrand').value === 'true',
      Quantity: $('#qty').value ? Number($('#qty').value) : undefined,
      Frequency: $('#qty').value ? Number($('#freq').value) : undefined,
      FromDate: $('#fromDate').value || new Date().toISOString().slice(0,10),
      ToDate: $('#toDate').value || undefined
    };
    if(!drug.NDC || !drug.DrugName || !drug.FromDate) { toast('NDC, Drug Name, From Date are required', 'error'); return; }
    if(drug.Quantity && !drug.Frequency){ toast('Frequency is required when Quantity is provided', 'error'); return; }

    let submissionType = (selectedDrug && selectedDrug.createdTime) ? 'Edit' : 'Add';
    if(submissionType==='Edit'){ drug.CreatedTime = selectedDrug.createdTime; }
    await submitMemberDrugs(submissionType, [drug]);
    toast(submissionType==='Add'?'Added ‚úÖ':'Updated ‚úÖ');
    $('#btnClear').click();
    await loadMember(currentMember.includeHistory);
  }catch(e){ toast(e.message,'error'); }
});

$('#btnClear').addEventListener('click', ()=>{
  selectedDrug = null;
  $$('#ndc,#drugName,#qty,#fromDate,#toDate').forEach(el=> el.value='');
  $('#isBrand').value='false'; $('#freq').value='';
});

// ====== SubmitMemberDrugs ======
async function submitMemberDrugs(submissionType, drugs){
  if(!currentMember.familyId && !currentMember.contactId) throw new Error('Provide FamilyId/ContactId first');

  const body = {
    RemoteAccessKey:null, WebsiteAccessKey:null,
    FamilyId: currentMember.familyId ? Number(currentMember.familyId) : undefined,
    ContactId: currentMember.contactId ? Number(currentMember.contactId) : undefined,
    MembersDrugs: [{
      MemberId: currentMember.memberId || undefined,
      MemberGUID: currentMember.memberGUID || undefined,
      SubmissionType: submissionType, // Add | Edit | Merge | Delete
      Drugs: (drugs && drugs.length) ? drugs : undefined
    }]
  };
  return postActWS('SubmitMemberDrugs', body);
}

// ====== GetFamily (Probe) ======
$('#btnProbe').addEventListener('click', async ()=>{
  const familyId  = $('#familyId').value.trim() || null;
  const contactId = $('#contactId').value.trim() || null;
  if(!familyId && !contactId){ toast('Provide FamilyId or ContactId', 'error'); return; }

  try{
    const body = {
      RemoteAccessKey: null, WebsiteAccessKey: null,
      FamilyId: familyId ? Number(familyId) : undefined,
      ContactId: contactId ? Number(contactId) : undefined
    };
    const resp = await postActWS('GetFamily', body);
    const members = (resp.Family && resp.Family.Members) || [];
    if(!members.length){ $('#probeOut').textContent = 'No members found under this ID.'; return; }

    const html = members.map(m=>`
      <div style="padding:6px 8px;border:1px solid #1f2937;border-radius:8px;margin-bottom:6px">
        <div><strong>${(m.FirstName||'').trim()} ${(m.LastName||'').trim()}</strong></div>
        <div class="muted" style="font-size:12px">MemberId: ${m.MemberId||'‚Äî'} ¬∑ MemberGUID: ${m.MemberGUID||'‚Äî'}</div>
        <div class="row" style="margin-top:6px">
          <button class="ghost" onclick="setMember('${m.MemberId||''}','${m.MemberGUID||''}')">Use this member</button>
        </div>
      </div>
    `).join('');
    $('#probeOut').innerHTML = html;
    window.setMember = (mid, mguid)=>{
      $('#memberId').value = mid || '';
      // If you later add a MemberGUID field, set it here as well.
      toast('Member selected. Now click ‚ÄúLoad current drugs‚Äù.');
    };
  }catch(e){
    $('#probeOut').textContent = 'Probe error: ' + e.message;
  }
});
</script>
</body>
</html>
