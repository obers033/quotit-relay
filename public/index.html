<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Member Medications</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent-2:#38bdf8; --danger:#ef4444; --input:#0b1220; --border:#1f2937; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0f172a 30%);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial}
    header{padding:24px 20px;border-bottom:1px solid var(--border);background:rgba(17,24,39,.6);backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    main{max-width:1060px;margin:28px auto;padding:0 16px 64px}
    .grid{display:grid;gap:16px}
    .cols-2{grid-template-columns:1fr 1fr}
    .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--border);border-radius:14px;padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select, button, textarea{font:inherit;color:var(--text);background:var(--input);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:none}
    input::placeholder{color:#64748b}
    button{cursor:pointer;border:1px solid #334155}
    button.primary{background:linear-gradient(135deg,var(--accent),#16a34a);color:#04120a}
    button.secondary{background:linear-gradient(135deg,var(--accent-2),#0ea5e9);color:#03121a}
    button.ghost{background:transparent;color:var(--muted)}
    button.danger{background:linear-gradient(135deg,#ef4444,#b91c1c);color:#1b0a0a}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .search-wrap{position:relative}
    .dropdown{position:absolute;left:0;right:0;top:100%;background:#0b1020;border:1px solid var(--border);border-radius:12px;margin-top:6px;max-height:320px;overflow:auto;z-index:20;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .dropdown .opt{padding:10px 12px;border-bottom:1px solid #0f172a;cursor:pointer}
    .dropdown .opt:hover,.dropdown .opt.active{background:#0d1426}
    .dropdown .hint{padding:10px 12px;color:#9ca3af;border-bottom:1px solid #0f172a}
    .dropdown .spinner{padding:10px 12px;color:#93c5fd}
    mark{background:transparent;color:#facc15}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:14px}
    th{color:#9ca3af;font-weight:600;background:#0c1224;position:sticky;top:70px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #334155;color:#a5b4fc}
    .stack{display:flex;flex-direction:column;gap:10px}
    .hint{font-size:12px;color:#93c5fd}
    .warn{font-size:12px;color:#fca5a5}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;border:1px solid #1f2a44;padding:12px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.5);display:none}
    .toast.show{display:block}
    .spacer{height:6px}
    @media (max-width:900px){ .cols-2{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <h1>Member Medications</h1>
  <div class="hint">Dual‚Äëmode: secure proxy (default) or direct-to-Quotit (unsafe; testing only). üî®ü§ñüîß</div>
</header>

<main>
  <div class="grid cols-2">
    <!-- LEFT: Member & Environment -->
    <section class="card stack">
      <h2 style="margin:0 0 6px 0;font-size:16px">Member & Environment</h2>

      <div class="row">
        <div>
          <label>Mode</label>
          <select id="mode">
            <option value="proxy">Proxy (secure, recommended)</option>
            <option value="direct">Direct to Quotit (unsafe)</option>
          </select>
        </div>
        <div>
          <label>Environment</label>
          <select id="env">
            <option value="stg">Staging</option>
            <option value="prod">Production</option>
          </select>
        </div>
      </div>

      <div id="keysWrap" class="row" style="display:none">
        <div>
          <label>RemoteAccessKey (GUID)</label>
          <input id="rak" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
        </div>
        <div>
          <label>WebsiteAccessKey (GUID)</label>
          <input id="wak" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" />
        </div>
      </div>
      <div class="row" id="rememberWrap" style="display:none;align-items:center">
        <label style="display:flex;gap:8px;align-items:center">
          <input type="checkbox" id="rememberKeys" />
          <span class="muted">Remember keys for this tab (sessionStorage)</span>
        </label>
        <button id="clearKeys" class="ghost" style="flex:0 0 auto">Clear saved</button>
      </div>
      <div id="warnDirect" class="warn" style="display:none">
        ‚ùó Direct mode exposes keys in the browser and can be blocked by CORS. Use only for quick testing.
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>FamilyId</label>
          <input id="familyId" placeholder="e.g. 12345" />
        </div>
        <div>
          <label>ContactId (alternative to FamilyId)</label>
          <input id="contactId" placeholder="e.g. 67890" />
        </div>
        <div>
          <label>MemberId (optional)</label>
          <input id="memberId" placeholder="e.g. 1 (string)" />
        </div>
        <div>
          <label>MemberGUID (optional)</label>
          <input id="memberGUID" placeholder="e.g. 855F...E43D6" />
        </div>
      </div>

      <div class="row">
        <button class="secondary" id="btnLoad">Load current drugs</button>
        <button class="ghost" id="btnLoadHistory">Load incl. history</button>
        <button class="ghost" id="btnProbe">Fetch Family (probe)</button>
      </div>
      <div id="probeOut" class="muted" style="margin-top:6px"></div>

      <div class="spacer"></div>
      <div class="hint">Enter <strong>FamilyId</strong> or <strong>ContactId</strong>. MemberId/MemberGUID are optional filters.</div>
    </section>

    <!-- RIGHT: Search/Add -->
    <section class="card stack">
      <h2 style="margin:0 0 6px 0;font-size:16px">Find a drug</h2>
      <div class="search-wrap">
        <label>Search by name, NDC or RxCUI</label>
        <input id="drugSearch" placeholder="Start typing e.g. ato‚Ä¶" autocomplete="off" />
        <div id="drugDropdown" class="dropdown" style="display:none"></div>
      </div>
      <div class="row">
        <div>
          <label>Selected NDC</label>
          <input id="ndc" placeholder="11-digit NDC" />
        </div>
        <div>
          <label>Drug Name</label>
          <input id="drugName" placeholder="Generic or brand" />
        </div>
        <div>
          <label>Is Brand?</label>
          <select id="isBrand">
            <option value="false">No (generic)</option>
            <option value="true">Yes (brand)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Quantity</label>
          <input id="qty" type="number" min="0" step="1" placeholder="e.g. 30" />
        </div>
        <div>
          <label>Frequency</label>
          <!-- STRING ENUM values -->
          <select id="freq">
            <option value="">--</option>
            <option value="Monthly">Monthly</option>
            <option value="Daily">Daily</option>
            <option value="Weekly">Weekly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Annually">Annually</option>
            <option value="SemiAnnually">SemiAnnually</option>
            <option value="Per30Days">Per30Days</option>
            <option value="Per60Days">Per60Days</option>
            <option value="Per90Days">Per90Days</option>
          </select>
        </div>
        <div>
          <label>From Date</label>
          <input id="fromDate" type="date" />
        </div>
        <div>
          <label>To Date (optional)</label>
          <input id="toDate" type="date" />
        </div>
      </div>

      <div class="row">
        <button class="primary" id="btnAdd">Add Drug</button>
        <button id="btnClear" class="ghost">Clear fields</button>
      </div>
      <div class="hint">NDC, Drug Name, and From Date are required. If you set Quantity, set Frequency (string enum) too.</div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2 style="margin:0 0 10px 0;font-size:16px">Current Drugs</h2>
    <div class="muted" id="memberLabel"></div>
    <div class="spacer"></div>
    <table id="tbl">
      <thead>
        <tr>
          <th>NDC</th><th>Name</th><th>Brand?</th><th>Qty/Freq</th><th>From ‚Üí To</th><th>Created</th><th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

  <!-- Diagnostics panel -->
  <section class="card" style="margin-top:16px">
    <h2 style="margin:0 0 10px 0;font-size:16px">Diagnostics</h2>
    <div class="row">
      <button id="btnDiag" class="secondary">Run diagnostics</button>
      <button id="btnLast" class="ghost">Show last request/response</button>
    </div>
    <div id="diagOut" class="muted" style="margin-top:10px; white-space:pre-wrap; word-break:break-word;"></div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
/** ========================
 *  CONFIG
 *  ======================== */
const CONFIG = {
  proxy: {
    stg: '/api/actws/stg',
    prod: '/api/actws/prod'
  },
  directBases: {
    stg: 'https://wwwstg.quotit.net/Quotit/Apps/Common/ActWS/ACA/v2',
    prod: 'https://www.quotit.net/Quotit/Apps/Common/ActWS/ACA/v2'
  },
  storageKeys: {
    rak: 'actws_rak',
    wak: 'actws_wak',
    remember: 'actws_remember'
  }
};

// UI helpers
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const toast = (msg, type='info') => {
  const t = $('#toast'); t.textContent = msg; t.classList.add('show');
  t.style.borderColor = type==='error' ? '#7f1d1d' : '#1f2a44';
  setTimeout(()=>t.classList.remove('show'), 3400);
};

// --- debug capture ---
let __last = { url:'', payload:null, response:null, error:null, status:null, bodyText:null };
function show(obj){ try{ return JSON.stringify(obj, null, 2);}catch{ return String(obj);} }

// State
let currentMember = { familyId:null, contactId:null, memberId:null, memberGUID:null, includeHistory:false };
let cachedRows = [];
let selectedDrug = null;
let lastMembers = []; // cache of last-known members

// ===== Remember Keys (sessionStorage) =====
function loadSavedKeys(){
  const remember = sessionStorage.getItem(CONFIG.storageKeys.remember) === '1';
  $('#rememberKeys').checked = remember;
  if (remember){
    $('#rak').value = sessionStorage.getItem(CONFIG.storageKeys.rak) || '';
    $('#wak').value = sessionStorage.getItem(CONFIG.storageKeys.wak) || '';
  }
}
function saveKeysIfOpted(){
  const remember = $('#rememberKeys').checked;
  sessionStorage.setItem(CONFIG.storageKeys.remember, remember ? '1' : '0');
  if (remember){
    sessionStorage.setItem(CONFIG.storageKeys.rak, $('#rak').value.trim());
    sessionStorage.setItem(CONFIG.storageKeys.wak, $('#wak').value.trim());
  } else {
    sessionStorage.removeItem(CONFIG.storageKeys.rak);
    sessionStorage.removeItem(CONFIG.storageKeys.wak);
  }
}
document.addEventListener('change', e=>{
  if(e.target && (e.target.id==='rememberKeys')) saveKeysIfOpted();
});
['rak','wak'].forEach(id=> document.addEventListener('input', e=>{ if(e.target && e.target.id===id) saveKeysIfOpted(); }));
$('#clearKeys').addEventListener('click', ()=>{
  sessionStorage.removeItem(CONFIG.storageKeys.rak);
  sessionStorage.removeItem(CONFIG.storageKeys.wak);
  sessionStorage.removeItem(CONFIG.storageKeys.remember);
  $('#rak').value = ''; $('#wak').value = ''; $('#rememberKeys').checked = false;
  toast('Cleared keys from sessionStorage');
});

// Mode toggling
$('#mode').addEventListener('change', onModeChange);
function onModeChange(){
  const direct = $('#mode').value === 'direct';
  $('#keysWrap').style.display = direct ? 'flex' : 'none';
  $('#rememberWrap').style.display = direct ? 'flex' : 'none';
  $('#warnDirect').style.display = direct ? 'block' : 'none';
  if (direct){ loadSavedKeys(); }
}
onModeChange(); // initialize on first paint

// Helpers
function apiTarget(method){
  const mode = $('#mode').value;
  const env  = $('#env').value;
  if (mode === 'proxy'){
    return { url: CONFIG.proxy[env], direct:false };
  } else {
    return { url: `${CONFIG.directBases[env]}/${method}`, direct:true };
  }
}

// ====== POST (instrumented) ======
async function postActWS(method, bodySansKeys){
  const { url, direct } = apiTarget(method);
  let body = bodySansKeys;

  if (direct){
    const rak = $('#rak').value.trim();
    const wak = $('#wak').value.trim();
    if(!rak || !wak) throw new Error('RemoteAccessKey and WebsiteAccessKey are required in Direct mode');
    body = { ...bodySansKeys, RemoteAccessKey: rak, WebsiteAccessKey: wak };
  }

  const payload = direct ? body : { method, body };
  __last = { url, payload, response:null, error:null, status:null, bodyText:null };

  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json; charset=utf-8'},
    body: JSON.stringify(payload)
  });

  __last.status = res.status;
  let data, text;
  try { data = await res.clone().json(); } catch { text = await res.text(); }
  __last.bodyText = text || null;

  if(!res.ok){
    __last.error = { status: res.status, body: text || data };
    throw new Error(`HTTP ${res.status}: ${text || (data ? JSON.stringify(data) : '(no body)')}`);
  }

  __last.response = data ?? text ?? null;
  return data ?? text ?? null;
}

/* ===========================
   DRUG SEARCH (Type-ahead) ‚Äî PATCHED
   =========================== */
const searchInput = $('#drugSearch');
const dropdown = $('#drugDropdown');

let searchTimer = null;
let activeIndex = -1;          // for keyboard nav
let lastList = [];             // current dropdown items
const searchCache = new Map(); // cache by lowercased query

// Close dropdown on outside click
document.addEventListener('click', (e)=>{
  if (!dropdown.contains(e.target) && e.target !== searchInput) {
    hideDropdown();
  }
});

searchInput.addEventListener('input', (e)=>{
  const q = e.target.value.trim();
  activeIndex = -1;
  if (searchTimer) clearTimeout(searchTimer);
  if (q.length < 2){ hideDropdown(); return; }
  searchTimer = setTimeout(()=> runDrugSearch(q).catch(err=>{
    showDropdownHint('Could not search right now. You can still enter NDC and Drug Name manually.');
    console.error(err);
  }), 220);
});

// Keyboard nav for dropdown
searchInput.addEventListener('keydown', (e)=>{
  if (dropdown.style.display === 'none') return;

  if (e.key === 'ArrowDown'){
    e.preventDefault();
    if (lastList.length === 0) return;
    activeIndex = (activeIndex + 1) % lastList.length;
    updateActive();
  } else if (e.key === 'ArrowUp'){
    e.preventDefault();
    if (lastList.length === 0) return;
    activeIndex = (activeIndex - 1 + lastList.length) % lastList.length;
    updateActive();
  } else if (e.key === 'Enter'){
    if (activeIndex >= 0 && activeIndex < lastList.length){
      e.preventDefault();
      chooseOption(lastList[activeIndex]);
    }
  } else if (e.key === 'Escape'){
    hideDropdown();
  }
});

function updateActive(){
  Array.from(dropdown.children).forEach((el,i)=>{
    el.classList.toggle('active', i===activeIndex);
  });
}

// Launch the search with caching + spinner (patched to allow proxy key injection)
async function runDrugSearch(keyword){
  const q = keyword.toLowerCase();

  // Cached?
  if (searchCache.has(q)){
    renderDrugOptions(keyword, searchCache.get(q));
    return;
  }

  // Spinner
  dropdown.innerHTML = `<div class="spinner">Searching ‚Äú${escapeHtml(keyword)}‚Äù ‚Ä¶</div>`;
  dropdown.style.display = 'block';

  // ‚¨áÔ∏è IMPORTANT: use top-level keys so proxy injects credentials
  const data = await postActWS('SearchRxDrugs', {
    RemoteAccessKey: 5F58063B-D73D-40AA-B7D0-6B2C4802EC52,
    WebsiteAccessKey: 5F58063B-D73D-40AA-B7D0-6B2C4802EC52,
    Inputs: { Keyword: keyword }
  });

  // Friendly hint if authentication still fails
  if (data?.IsSuccess === false && Array.isArray(data.Errors)) {
    const authErr = data.Errors.find(e => /auth/i.test(e));
    if (authErr) {
      showDropdownHint('Authentication failed (SearchRxDrugs). Try Direct mode with your keys, or update the proxy to inject keys for this method.');
      return;
    }
  }

  // Some accounts may not have realtime search; handle gracefully
  const list = (data?.Drugs || []).slice(0, 50); // cap for UX
  searchCache.set(q, list);
  renderDrugOptions(keyword, list);

  if (!list.length){
    showDropdownHint(
      'No matches. If search stays empty, ask Quotit to enable real‚Äëtime keyword for SearchRxDrugs, or enter NDC manually.'
    );
  }
}

function renderDrugOptions(keyword, drugs){
  dropdown.innerHTML = '';
  const qlc = keyword.toLowerCase();
  lastList = [];

  drugs.forEach(drug=>{
    const brand = drug.BrandName || '';
    const generic = drug.GenericName || '';
    const title = (brand || generic || 'Unnamed').trim();

    (drug.DrugPackages || []).slice(0, 2).forEach(pkg=>{
      // Build display lines
      const ndc = String(pkg.NDC || '').trim();
      const isBrand = !!pkg.IsBrand;
      const nameToShow = title || (pkg.FDAProductName || '');
      const hi = highlight(nameToShow, qlc);

      const div = document.createElement('div');
      div.className = 'opt';
      div.innerHTML = `
        <div><strong>${hi}</strong> ${ndc ? `<span class="pill">${ndc}</span>`:''}</div>
        <div class="muted" style="font-size:12px">${escapeHtml(pkg.FDAProductName||'')}${pkg.PackageDescription ? ' ¬∑ ' + escapeHtml(pkg.PackageDescription) : ''}</div>
      `;
      const option = {
        ndc,
        name: (generic || brand || pkg.FDAProductName || '').trim(),
        isBrand
      };
      div.onclick = ()=> chooseOption(option);
      dropdown.appendChild(div);
      lastList.push(option);
    });
  });

  if (!dropdown.childElementCount){
    dropdown.innerHTML = `<div class="hint">No results for ‚Äú${escapeHtml(keyword)}‚Äù.</div>`;
  }
  dropdown.style.display = 'block';
  activeIndex = -1;
}

function chooseOption(option){
  selectedDrug = { ndc: option.ndc, name: option.name, isBrand: !!option.isBrand };
  $('#ndc').value = selectedDrug.ndc || '';
  $('#drugName').value = selectedDrug.name || '';
  $('#isBrand').value = selectedDrug.isBrand ? 'true' : 'false';
  hideDropdown();
}

function hideDropdown(){
  dropdown.style.display = 'none';
  dropdown.innerHTML = '';
  lastList = [];
  activeIndex = -1;
}

function showDropdownHint(text){
  dropdown.innerHTML = `<div class="hint">${escapeHtml(text)}</div>`;
  dropdown.style.display = 'block';
}

// utils for highlighting & escaping
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function highlight(text, qlc){
  const t = text || '';
  const i = t.toLowerCase().indexOf(qlc);
  if (i === -1) return escapeHtml(t);
  const a = escapeHtml(t.slice(0,i));
  const b = escapeHtml(t.slice(i, i+qlc.length));
  const c = escapeHtml(t.slice(i+qlc.length));
  return `${a}<mark>${b}</mark>${c}`;
}

/* ===========================
   LOAD / TABLE / SUBMIT
   =========================== */
$('#btnLoad').addEventListener('click', ()=> loadMember(false));
$('#btnLoadHistory').addEventListener('click', ()=> loadMember(true));

async function loadMember(includeHistory){
  const fam = $('#familyId').value.trim() || null;
  const con = $('#contactId').value.trim() || null;
  const mid = $('#memberId').value.trim() || null;
  const mg  = $('#memberGUID').value.trim() || null;

  if(!fam && !con){ toast('Provide FamilyId or ContactId', 'error'); return; }
  if(mid && !fam){ toast('MemberId requires FamilyId. Or use MemberGUID instead.', 'error'); return; }

  currentMember = { familyId:fam, contactId:con, memberId:mid, memberGUID:mg, includeHistory };

  try{
    const resp = await postActWS('GetMemberDrugs', {
      RemoteAccessKey: null, WebsiteAccessKey: null,
      FamilyId: fam ? fam.toString() : undefined,
      ContactId: con ? con.toString() : undefined,
      MemberId: mid || undefined,      // string
      MemberGUID: mg || undefined,     // string
      IncludeHistoricalData: !!includeHistory
    });

    const buckets = resp?.MembersDrugs || [];
    lastMembers = buckets.map(m => ({ MemberId: String(m.MemberId || ''), MemberGUID: String(m.MemberGUID || '') }));

    const rows = buckets.flatMap(m => (m.Drugs||[]).map(d => ({ memberId:m.MemberId||m.MemberGUID, ...d })));
    cachedRows = rows;
    const msg = rows.length
      ? `${rows.length} drug(s) found` + (mid||mg ? ` for member ${mid||mg}` : ' (all members)') + (includeHistory?' ¬∑ incl. history':'')
      : 'No drugs found for the supplied IDs.';
    $('#memberLabel').textContent = msg;
    renderTable();
  }catch(e){
    toast(`Error: ${e.message}`, 'error');
  }
}

function renderTable(){
  const tb = $('#tbody'); tb.innerHTML='';
  if (!cachedRows.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="7" class="muted">No drug records to display.</td>`;
    tb.appendChild(tr);
    return;
  }
  cachedRows.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    const range = (r.ToDate ? `${r.FromDate} ‚Üí ${r.ToDate}` : `${r.FromDate} ‚Üí ‚Ä¶`);
    tr.innerHTML = `
      <td>${r.NDC}</td>
      <td>${r.DrugName}</td>
      <td>${r.IsBrand ? 'Brand' : 'Generic'}</td>
      <td>${(r.Quantity??'‚Äì')}/${(r.Frequency || '‚Äì')}</td>
      <td>${range}</td>
      <td><span class="muted" title="CreatedTime">${r.CreatedTime || '‚Äî'}</span></td>
      <td class="row" style="gap:6px">
        <button class="ghost" onclick="prefill(${idx})">Edit</button>
        <button class="danger" onclick="deleteDrug(${idx})">Delete</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}
window.prefill = (i)=>{
  const r = cachedRows[i];
  $('#ndc').value = r.NDC; $('#drugName').value = r.DrugName; $('#isBrand').value = r.IsBrand?'true':'false';
  $('#qty').value = r.Quantity ?? ''; $('#freq').value = r.Frequency || '';
  $('#fromDate').value = r.FromDate ? r.FromDate.substring(0,10) : ''; $('#toDate').value = r.ToDate ? r.ToDate.substring(0,10) : '';
  selectedDrug = { ndc:r.NDC, name:r.DrugName, isBrand:!!r.IsBrand, createdTime:r.CreatedTime };
  toast('Loaded drug into editor. Edit then click ‚ÄúAdd Drug‚Äù to save changes as Edit.');
};

window.deleteDrug = async (i)=>{
  const r = cachedRows[i];
  if(!confirm(`Delete ${r.DrugName} (${r.NDC})?`)) return;
  try{
    await submitMemberDrugs('Delete', [{ ...r }]);
    toast('Deleted ‚úÖ');
    await loadMember(currentMember.includeHistory);
  }catch(e){ toast(e.message,'error');}
};

// ====== ADD / EDIT ======
$('#btnAdd').addEventListener('click', async ()=>{
  try{
    const drug = {
      NDC: $('#ndc').value.trim(),
      DrugName: $('#drugName').value.trim(),
      IsBrand: $('#isBrand').value === 'true',
      Quantity: $('#qty').value ? Number($('#qty').value) : undefined,
      Frequency: $('#qty').value ? $('#freq').value : undefined, // STRING ENUM
      FromDate: $('#fromDate').value || new Date().toISOString().slice(0,10),
      ToDate: $('#toDate').value || undefined
    };
    if(!drug.NDC || !drug.DrugName || !drug.FromDate) { toast('NDC, Drug Name, From Date are required', 'error'); return; }
    if(drug.Quantity && !drug.Frequency){ toast('Frequency (string enum) is required when Quantity is provided', 'error'); return; }
    if(!/^\d{11}$/.test(String(drug.NDC))) { toast('NDC must be exactly 11 digits (leading zeros matter).', 'error'); return; }

    let submissionType = (selectedDrug && selectedDrug.createdTime) ? 'Edit' : 'Add';
    if(submissionType==='Edit'){ drug.CreatedTime = selectedDrug.createdTime; } // required for Edit

    await submitMemberDrugs(submissionType, [drug]);
    toast(submissionType==='Add'?'Added ‚úÖ':'Updated ‚úÖ');
    $('#btnClear').click();
    await loadMember(currentMember.includeHistory);
  }catch(e){ toast(e.message,'error'); }
});

$('#btnClear').addEventListener('click', ()=>{
  selectedDrug = null;
  $$('#ndc,#drugName,#qty,#fromDate,#toDate').forEach(el=> el.value='');
  $('#isBrand').value='false'; $('#freq').value='';
});

/* ====== SubmitMemberDrugs (member targeting, validations, diag echo) ====== */
async function submitMemberDrugs(submissionType, drugs){
  const fam = ($('#familyId').value.trim() || null);
  const con = ($('#contactId').value.trim() || null);
  let   mid = ($('#memberId').value.trim() || null);
  let   mg  = ($('#memberGUID').value.trim() || null);

  if(!fam && !con) throw new Error('Provide FamilyId or ContactId first');

  // Auto-target if we have exactly one member known
  if(!mid && !mg && lastMembers.length === 1){
    mid = lastMembers[0].MemberId || null;
    mg  = lastMembers[0].MemberGUID || null;
  }

  // Rule: MemberId requires FamilyId; otherwise use MemberGUID
  if(mid && !fam){
    throw new Error('MemberId requires FamilyId. Either enter FamilyId + MemberId, or use MemberGUID.');
  }

  // Must target a member
  if(!mid && !mg){
    throw new Error('Pick a member first (probe ‚Üí ‚ÄúUse this member‚Äù), or enter MemberGUID.');
  }

  // Validate each drug
  if (Array.isArray(drugs)) {
    for (const d of drugs) {
      if (!/^\d{11}$/.test(String(d.NDC||''))) {
        throw new Error(`NDC must be exactly 11 digits (got "${d.NDC || ''}")`);
      }
      if (d.Quantity != null && (!d.Frequency || typeof d.Frequency !== 'string')) {
        throw new Error('Frequency (string enum, e.g., "Per30Days") is required when Quantity is provided');
      }
      if ((submissionType === 'Edit' || submissionType === 'Delete' || submissionType === 'Merge') && !d.CreatedTime) {
        throw new Error(`${submissionType} requires CreatedTime on the drug record (prefill first, then submit).`);
      }
    }
  }

  const body = {
    RemoteAccessKey:null, WebsiteAccessKey:null,
    FamilyId: fam ? fam.toString() : undefined,
    ContactId: con ? con.toString() : undefined,
    MembersDrugs: [{
      MemberId: mid || undefined,             // string (requires FamilyId)
      MemberGUID: mg || undefined,            // string
      SubmissionType: submissionType,         // Add | Edit | Merge | Delete
      Drugs: (drugs && drugs.length) ? drugs : undefined
    }]
  };

  const resp = await postActWS('SubmitMemberDrugs', body);

  // Echo call details to diagnostics
  $('#diagOut').textContent =
    `Last URL:\n${__last.url}\n\n` +
    `Status:\n${__last.status}\n\n` +
    `Payload:\n${show(__last.payload)}\n\n` +
    `Response (parsed):\n${show(__last.response)}\n\n` +
    `Response (raw text):\n${__last.bodyText || '(none)'}\n\n` +
    `Error:\n${show(__last.error)}`;

  toast(`SubmitMemberDrugs OK ‚Ä¢ RequestId=${resp?.RequestId ?? '‚Äî'}`);
  return resp;
}

/* ====== GetFamily (Probe) ====== */
$('#btnProbe').addEventListener('click', async ()=>{
  const familyId  = $('#familyId').value.trim() || null;
  const contactId = $('#contactId').value.trim() || null;
  if(!familyId && !contactId){ toast('Provide FamilyId or ContactId', 'error'); return; }

  try{
    const body = {
      RemoteAccessKey: null, WebsiteAccessKey: null,
      FamilyId: familyId ? familyId.toString() : undefined,
      ContactId: contactId ? contactId.toString() : undefined
    };
    const resp = await postActWS('GetFamily', body);
    const members = (resp?.Family?.Members) || [];
    if(!members.length){ $('#probeOut').textContent = 'No members found under this ID.'; return; }

    const html = members.map(m=>`
      <div style="padding:6px 8px;border:1px solid #1f2937;border-radius:8px;margin-bottom:6px">
        <div><strong>${(m.FirstName||'').trim()} ${(m.LastName||'').trim()}</strong></div>
        <div class="muted" style="font-size:12px">
          MemberId: ${m.MemberId||'‚Äî'} ¬∑ MemberGUID: ${m.MemberGUID||'‚Äî'}
        </div>
        <div class="row" style="margin-top:6px">
          <button class="ghost" onclick="setMember('${m.MemberId||''}','${m.MemberGUID||''}')">Use this member</button>
        </div>
      </div>
    `).join('');
    $('#probeOut').innerHTML = html;

    // cache members from probe
    lastMembers = members.map(m => ({ MemberId: String(m.MemberId || ''), MemberGUID: String(m.MemberGUID || '') }));

    window.setMember = (mid, mguid)=>{
      $('#memberId').value = mid || '';
      $('#memberGUID').value = mguid || '';
      lastMembers = [{ MemberId: mid || null, MemberGUID: mguid || null }];
      toast('Member selected. Now click ‚ÄúLoad current drugs‚Äù or add a new drug.');
    };
  }catch(e){
    $('#probeOut').textContent = 'Probe error: ' + e.message;
  }
});

/* ====== Diagnostics quick actions ====== */
$('#btnLast').addEventListener('click', ()=>{
  $('#diagOut').textContent =
    `Last URL:\n${__last.url}\n\n` +
    `Status:\n${__last.status}\n\n` +
    `Payload:\n${show(__last.payload)}\n\n` +
    `Response (parsed):\n${show(__last.response)}\n\n` +
    `Response (raw text):\n${__last.bodyText || '(none)'}\n\n` +
    `Error:\n${show(__last.error)}`;
});

$('#btnDiag').addEventListener('click', async ()=>{
  const familyId  = $('#familyId').value.trim() || null;
  const contactId = $('#contactId').value.trim() || null;

  const out = [];
  const log = (label, obj)=> out.push(`‚ñ∂ ${label}:\n${show(obj)}\n`);

  try{
    // 1) Sanity: verifies keys/env via drug search
    const rx = await postActWS('SearchRxDrugs', { RemoteAccessKey:null, WebsiteAccessKey:null, Inputs:{ Keyword:'atorvastatin' }});
    log('SearchRxDrugs atorvastatin (count)', { count: (rx?.Drugs ? rx.Drugs.length : 0) });

    // 2) If family/contact provided, probe members
    if (familyId || contactId){
      const gf = await postActWS('GetFamily', {
        RemoteAccessKey:null, WebsiteAccessKey:null,
        FamilyId: familyId ? familyId.toString() : undefined,
        ContactId: contactId ? contactId.toString() : undefined
      });
      log('GetFamily.Members (first 3)', Array.isArray(gf?.Family?.Members) ? gf.Family.Members.slice(0,3) : gf);

      // 3) GetMemberDrugs WITHOUT member filter
      const gmd = await postActWS('GetMemberDrugs', {
        RemoteAccessKey:null, WebsiteAccessKey:null,
        FamilyId: familyId ? familyId.toString() : undefined,
        ContactId: contactId ? contactId.toString() : undefined,
        IncludeHistoricalData: false
      });
      log('GetMemberDrugs summary', {
        members: (gmd?.MembersDrugs ? gmd.MembersDrugs.length : 0),
        first: (gmd?.MembersDrugs?.[0]) ? {
          MemberId: gmd.MembersDrugs[0].MemberId || gmd.MembersDrugs[0].MemberGUID,
          drugs: (gmd.MembersDrugs[0].Drugs||[]).length
        } : null
      });

      // cache last known members
      const buckets = gmd?.MembersDrugs || [];
      lastMembers = buckets.map(m => ({ MemberId: String(m.MemberId || ''), MemberGUID: String(m.MemberGUID || '') }));
    } else {
      out.push('‚ÑπÔ∏è Provide FamilyId or ContactId for GetFamily/GetMemberDrugs probes.\n');
    }

  }catch(e){
    out.push('‚ùå Diagnostics error:\n' + e.message + '\n');
    out.push('Tip: if SearchRxDrugs returns empty due to permissions, you can still enter NDC + Drug Name manually.\n');
  }

  $('#diagOut').textContent = out.join('\n');
});
</script>
</body>
</html>
